#!/bin/sh
# insta2w3c
#
# Copyright Â© 2016 Dynamic Object Language Labs Inc.
#
# This software is licensed under the terms of the
# Apache License, Version 2.0 which can be found in
# the file LICENSE at the root of this distribution.

# Acknowledgement and Disclaimer:
# This material is based upon work supported by the Army Contracting
# and DARPA under contract No. W911NF-15-C-0005.
# Any opinions, findings and conclusions or recommendations expressed
# in this material are those of the author(s) and do necessarily reflect the
# views of the Army Contracting Command and DARPA.

# For reference see
# https://www.w3.org/TR/xquery/#EBNFNotation
# http://www.bottlecaps.de/rr/ui

program=$(basename $0)

dir=$(dirname $0)
export PAMELA_CWD="$(pwd -P)"
cd "$dir/.."
dir="$(pwd -P)"
insta="$dir/resources/public/pamela.ebnf"

log() {
  echo >&2 "$*"
}

err() {
  log "${program}: $*"
}

file="$1"
if [ -n "$file" ]; then
    if [ ! -e "$file" ]; then
        if [ -e "$PAMELA_CWD/$file" ]; then
            file="$PAMELA_CWD/$file"
        else
            err "input file does not exist: $file"
            exit 1
        fi
    fi
else
    file="$insta"
fi

echo "Converting Instaparse EBNF file: $file"
w3c="$file.w3c"

# Guard the asterisks in the heading below
set -f
filename=$(basename $file)
heading="/* For the most part, this file is automatically generated by insta2w3c from $filename */\n/* There are a few, minor hand-edits required for symbol, keyword, and float */"

echo $heading > $w3c

sed -e 's/(\*.*\*)//' \
    -e 's/\![a-z-]*//g' \
    -e 's/<//g' \
    -e 's/>//g' \
    -e 's/ = / ::= /g' \
    -e "s/#'\([^']*\)'/\1/g" \
    $file >> $w3c

echo "Created the W3C EBNF file: $w3c"
